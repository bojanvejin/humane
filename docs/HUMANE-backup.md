# ETHICAL DSP (Working title: **HUMANE**) ‚Äî Vision & MVP Spec

> An artist‚Äëfirst, transparency‚Äëby‚Äëdefault platform that blends fair streaming with direct patronage, built lean enough to ship as a web app in weeks, not months.

---

## Mock UI Concepts

### 1) **Fan Receipt (Web & PWA)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HUMANE ‚Äî Your Monthly Support Receipt     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Subscription: $9.00                       ‚îÇ
‚îÇ Platform fee: $1.08                       ‚îÇ
‚îÇ Processing: $0.27                         ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ Net distributed to artists: $7.65         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üéµ Artists you supported this month        ‚îÇ
‚îÇ-------------------------------------------‚îÇ
‚îÇ EL.WAV          46%   $3.52               ‚îÇ
‚îÇ Geneva          27%   $2.06               ‚îÇ
‚îÇ Pinto NYC       19%   $1.45               ‚îÇ
‚îÇ Suray Sertin     8%   $0.62               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üí°Tip sent to Geneva: $2.00                ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ Total direct artist support: $9.65        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Fan POV:** They instantly see where their money went. They can share this receipt with one click (social proof).  
**Artist POV:** They can download their CSV that matches this breakdown exactly.

---

### 2) **Artist Dashboard (Core Tabs)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Logo] HUMANE Dashboard ‚Äî Artist View       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Catalog | Releases | Earnings | Splits | ‚öô ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Current Balance: $218.44 (‚Üë $32 since last) ‚îÇ
‚îÇ Next Payout: Feb 1, 2025 via Stripe         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Recent Activity                             ‚îÇ
‚îÇ---------------------------------------------‚îÇ
‚îÇ + $12.00 Direct Unlock ‚Äî "Shy City EP"      ‚îÇ
‚îÇ + $2.00 Tip from fan (Toronto)              ‚îÇ
‚îÇ + $38.20 Monthly Payout (UCPS)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Top Tracks (Jan 2025)                       ‚îÇ
‚îÇ---------------------------------------------‚îÇ
‚îÇ Violet                1,284 streams         ‚îÇ
‚îÇ Corny Love Song         912 streams         ‚îÇ
‚îÇ Fela                    740 streams         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Quick toggles:** Beside each release: `Public ¬∑ Subs‚ÄëOnly ¬∑ Supporters‚ÄëOnly ¬∑ Unlock`.

---

### 3) **Public Player (Fan Side)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HUMANE Player                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [Cover Art]                               ‚îÇ
‚îÇ Track: Violet                             ‚îÇ
‚îÇ Artist: EL.WAV                            ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ ‚ñ∂ 00:00  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 03:42 ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ ‚ô• Like   ‚Üó Share   üí∏ Support ($1-$10)     ‚îÇ
‚îÇ                                           ‚îÇ
‚îÇ üîì Public  |  üîí Subs‚ÄëOnly  |  üîë Unlock   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Discovery transparency:** Each recommendation has a small info‚Äëicon: ‚ÄúWhy am I seeing this? ‚Üí You follow Geneva ¬∑ Similar tags: Deep House.‚Äù

---

## Placement
These mock UIs can be used as:
- Landing screenshots for early pitch decks.
- Frontend wireframes for Sprint‚Äë1 implementation.
- Marketing collateral (the **fan receipt** is especially viral‚Äëready).

---

**Next step:** If you want, I can turn these into polished Figma/Tailwind mockups so your coders can implement pixel‚Äëready components directly.



---

# üöÄ HUMANE ‚Äî Full Build Scaffolding & Agent Superprompt

> Drop-in repo layout, commands, epics ‚Üí tickets, API contracts, rules, and CI you can paste straight into your tools. Use this with your AI dev agents + human team.

## 0) Project Identity
- **Code name:** HUMANE
- **Mission:** Ethical, artist‚Äëfirst DSP blending fair streaming (UCPS) with direct patronage (tips, unlocks, memberships) and radical transparency.
- **Core V1:** **Switch** model (public/subscribers/supporters/unlock) + UCPS payouts + tips + direct unlocks + Stripe Connect.

---

## 1) Monorepo Structure (Vercel + Firebase + Stripe)
```
humane/
  apps/
    web/                  # Next.js 14 (app router, PWA), Tailwind, shadcn/ui
    admin/                # (optional, later) ops console
  packages/
    ui/                   # shared React components + design tokens
    config/               # ESLint, TS, Tailwind, Prettier configs
    lib/                  # shared ts libs (auth, api client, analytics)
  services/
    functions/            # Firebase/Cloud Run functions (TS)
    transcoder/           # ffmpeg HLS pipeline (Node wrapper + scripts)
    webhooks/             # Stripe webhooks handler (Cloud Run)
  infra/
    firebase/             # firestore.rules, storage.rules, indexes, emulators
    vercel/               # vercel.json, build settings
    github/               # CI workflows
  docs/
    product/              # PRD, UI flows, acceptance criteria
    api/                  # OpenAPI + event schemas
    ops/                  # runbooks, on-call, fraud playbooks
  .env.example
  package.json            # pnpm workspaces
  turbo.json              # Turborepo
  README.md
```

### Package managers & engines
- **pnpm** workspaces + **Turborepo** for caching
- Node 20 LTS

---

## 2) Quick Start Commands
```bash
# 0) prerequisites (macOS)
brew install pnpm ffmpeg
curl -sL https://firebase.tools | bash

# 1) clone & bootstrap
# Use GitHub Desktop to clone locally ‚Üí then in Terminal:
pnpm i

# 2) env
cp .env.example .env.local
# (Values already filled for Firebase client config above.)

# 3) Firebase local emulators
firebase login
firebase use humane-io   # sets default project
firebase emulators:start --import=./infra/firebase/emulator-data --export-on-exit

# 4) web dev (Next.js + emulators)
pnpm dev

# 5) first deploy (hosting + functions to staging or prod)
firebase deploy --project humane-io
```

**.firebaserc**
```json
{
  "projects": { "default": "humane-io" }
}
```

**firebase.json** (snippet)
```json
{
  "hosting": { "public": "apps/web/out", "ignore": ["firebase.json","**/.*","**/node_modules/**"] },
  "functions": { "source": "services/functions" },
  "emulators": { "functions": { "port": 5001 }, "firestore": { "port": 8080 }, "auth": { "port": 9099 }, "storage": { "port": 9199 } }
}
```

---

## 3) Design System & UX Foundations
- **Type scale:** 12/14/16/18/24/32/48
- **Color tokens:**
  - `--brand: #0A84FF` (accessible variants A/B)
  - `--bg: #0B0B0C`, `--card: #141417`, `--text: #F4F5F7`, `--muted: #A0A3A8`
- **Components:** Button, Card, Badge, Table, Tabs, Drawer, Dialog
- **Layouts:** Dashboard (left nav), Player (bottom sticky), Receipt (card list)
- **Motion:** 150‚Äì200ms ease, prefers-reduced-motion respected
- **Accessibility:** WCAG AA, focus rings, full keyboard navigation

---

## 4) Firestore Data Model (finalized for MVP)
```
/users/{userId}
  displayName, photoURL, roles[], country, createdAt, consent{},
  stripeCustomerId, deviceHashes[]

/artists/{artistId}
  ownerUserId, name, bio, socials{}, verified, stripeConnectId

/releases/{releaseId}
  artistIds[], title, coverUrl, accessMode, windowFrom, windowTo,
  buyPrice, upc, publishedAt, splits[]

/tracks/{trackId}
  releaseId, artistIds[], title, isrc, durationMs,
  accessMode, explicit, tags[], bpm, key,
  storage{masterPath, hlsPath}

/plays_raw/{yyyymm}/{eventId}
  userId, trackId, artistIds[], msPlayed, durationMs, sessionId,
  deviceHash, ipHash, userAgent, heartbeatCount, createdAt, signed

/plays/{yyyymm}/{playId}
  userId, trackId, artistIds[], msPlayed, completed, weight, suspicious,
  createdAt

/tips/{tipId}
  fromUserId, toArtistId, trackId?, amount, currency, status, createdAt

/subscriptions/{subId}
  userId, plan, status, netMonthly, startedAt, currentPeriod

/payouts/{batchId}
  period, artistId, amount, breakdown{}, status, createdAt

/flags/{flagId}
  kind, subjectId, notes, status, evidence{}, createdAt
```

---

## 5) Security Rules (tight defaults)
**firestore.rules** (excerpt)
```js
rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function authed() { return request.auth != null; }
    function has(role) { return authed() && role in request.auth.token.roles; }

    match /users/{uid} {
      allow read: if authed() && (request.auth.uid == uid || has('admin'));
      allow write: if request.auth.uid == uid;
    }

    match /artists/{id} {
      allow read: if true; // public
      allow create, update: if has('artist') && request.auth.uid == resource.data.ownerUserId;
    }

    match /plays/{period}/{id} {
      allow read: if has('admin');
      allow write: if false; // server-only via CF
    }

    match /plays_raw/{period}/{id} {
      allow read: if has('admin');
      allow write: if authed(); // but validated server-side before materialization
    }
  }
}
```

**storage.rules** (excerpt)
```js
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function authed() { return request.auth != null; }
    match /masters/{uid}/{allPaths=**} {
      allow read: if false; // private
      allow write: if authed() && request.auth.uid == uid;
    }
    match /hls/{public=**} {
      allow read: if request.time < timestamp.date(9999,1,1); // served via signed URLs/CDN
      allow write: if false; // pipeline only
    }
  }
}
```

---

## 6) Cloud Functions / Jobs (TypeScript stubs)
```
functions/
  src/
    index.ts
    auth/onCreate.ts
    uploads/onFinalize.ts          // transcode to HLS, watermark tag
    plays/reportPlayBatch.ts       // validate tokens ‚Üí /plays_raw
    plays/materializeRaw.ts        // rules + weights ‚Üí /plays
    payouts/closeMonth.ts          // UCPS compute ‚Üí /payouts
    payouts/issuePayouts.ts        // Stripe transfers
    webhooks/stripe.ts             // tips/subscriptions events
```

**reportPlayBatch.ts (sketch)**
```ts
export const reportPlayBatch = onCall(async (ctx, data) => {
  assertAuthed(ctx);
  validateSignature(data.token, ctx.auth!.uid);
  const events = sanitizeEvents(data.events);
  await writeRaw(events);           // /plays_raw/YYYYMM
  return { ok: true };
});
```

**materializeRaw.ts (sketch)**
```ts
export const materializeRaw = onDocumentCreated('/plays_raw/{period}/{id}', async (snap) => {
  const e = snap.data();
  const suspicious = isSuspicious(e);
  const weight = computeWeight(e);
  await db.collection(`plays/${snap.params.period}`).add({
    userId: e.userId, trackId: e.trackId, artistIds: e.artistIds,
    msPlayed: e.msPlayed, completed: e.msPlayed >= 0.85*e.durationMs,
    weight, suspicious, createdAt: serverTimestamp()
  });
});
```

**closeMonth.ts (UCPS)**
```ts
export const closeMonth = onSchedule('every month 00:05', async () => {
  const period = lastMonthYYYYMM();
  const subs = await activeSubs(period);
  const payouts = new Map<string, number>();
  for (const u of subs) {
    const Ru = netAllocatable(u, period);
    const plays = await qualifiedPlays(u.id, period); // suspicious=false
    const T  = sum(plays.map(p => p.weight * p.msPlayed));
    for (const p of plays) {
      const share = (p.weight * p.msPlayed) / T;
      for (const a of p.artistIds) payouts.set(a, (payouts.get(a)||0) + Ru*share);
    }
  }
  await writePayouts(period, payouts);
});
```

---

## 7) Stripe Integration (Connect Express)
- **Products/Prices:** `fan_monthly`, `supporter_monthly`, `global_pass` (later)
- **Flow:** Checkout ‚Üí customer portal for upgrades/cancellations
- **Tips:** `PaymentIntent` with destination charges to artist `connectId`
- **Direct Unlocks:** `Product: release_{id}` with one-time price
- **Webhooks:** `checkout.session.completed`, `invoice.paid`, `payment_intent.succeeded`, `transfer.created`

**Webhook payload mapper** ‚Üí Firestore events
```
/webhooks/events/{eventId}
  type, objectId, status, raw, processedAt
```

---

## 8) Transcode & Delivery (HLS)
- Upload: WAV/FLAC ‚Üí GCS `masters/`
- Cloud Run job uses **ffmpeg** to produce HLS ladder (96/128/192 kbps AAC)
- Store to `hls/{trackId}/index.m3u8` with short‚Äëlived signed URL issuance
- Basic forensic watermark: low‚Äëdepth per‚Äësegment amplitude mark (config flag)

**ffmpeg baseline**
```bash
ffmpeg -i input.wav -filter_complex "aresample=48000"
  -map 0:a -c:a aac -b:a 96k -hls_time 4 -hls_segment_type mpegts -hls_flags independent_segments out_96k.m3u8
# repeat for 128k/192k and combine master playlist
```

---

## 9) API Contracts (client ‚Üî server)

### Firebase client init (Next.js)
Create `packages/lib/src/firebaseClient.ts`:
```ts
import { initializeApp, getApps } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getAnalytics, isSupported } from 'firebase/analytics';
import { getFirestore } from 'firebase/firestore';
import { getStorage } from 'firebase/storage';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY!,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN!,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID!,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET!,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID!,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID!,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID,
};

export const app = getApps().length ? getApps()[0]! : initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);
export const storage = getStorage(app);
export const analyticsPromise = isSupported().then((ok) => ok ? getAnalytics(app) : null);
```

Use this in `apps/web` only on the client where needed; avoid running analytics in SSR.

---

### HTTP Endpoints

**POST** `/api/plays/report-batch`  
Body: `{ token: string, events: PlayEvent[] }`
```
PlayEvent = {
  trackId: string;
  msPlayed: number; durationMs: number;
  sessionId: string; heartbeatCount: number;
  deviceHash: string; userAgent: string; ts: number;
}
```
Response: `{ ok: true }`

**GET** `/api/receipts/:period` ‚Üí Fan receipt breakdown
**GET** `/api/artist/earnings/:period` ‚Üí Artist CSV

OpenAPI yaml included in `docs/api/openapi.yaml` (stubbed, expand during dev).

---

## 10) Fraud Controls (operationalized)
- **Rules:** min 20s or 50% play; dedupe window; per‚Äëartist caps; new‚Äëuser throttles
- **Signals:** deviceHash, ipHash, heartbeat ratios, completion distribution
- **Actions:** mark suspicious ‚Üí excluded from UCPS; quarantine pool; review queue
- **KPIs:** % suspicious plays, overturn rate, time‚Äëto‚Äëresolution

Runbook ‚Üí `docs/ops/fraud-playbook.md` (to be filled with thresholds after week 2).

---

## 11) CI/CD
- **GitHub Actions**
  - `ci.yml`: lint + typecheck + unit tests on PRs
  - `deploy-staging.yml`: on merge to `main` ‚Üí Vercel preview + Firebase hosting/functions to `staging`
  - `deploy-prod.yml`: tag `v*.*.*` ‚Üí production deploy, run post‚Äëdeploy smoke tests

**ci.yml (excerpt)**
```yaml
name: CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'pnpm' }
      - run: pnpm i
      - run: pnpm lint && pnpm tsc -b && pnpm test
```

---

## 12) Testing Strategy
- **Unit:** utils, UCPS math, rules
- **Contract:** API schemas via zod + pact tests (web ‚Üî functions)
- **E2E:** Playwright flows (signup, upload, set access mode, play, tip, receipt)
- **Load:** k6 script for play ingestion and HLS segment fetch
- **Security:** OWASP zap baseline; dependency scanning (Snyk/GH)

---

## 13) Product Epics ‚Üí User Stories ‚Üí Tickets

### EPIC A ‚Äî Auth & Roles
- [A1] Email/Google/Apple Auth (fan, artist, admin)
- [A2] Role claims and guard routes
- [A3] Profile edit & data export/delete (GDPR-lite)

### EPIC B ‚Äî Catalog & Uploads
- [B1] Artist dashboard shell
- [B2] Upload WAV/FLAC ‚Üí HLS pipeline
- [B3] Metadata form (ISRC, splits invite)
- [B4] Access mode toggles per release/track

### EPIC C ‚Äî Player & Paywall
- [C1] PWA player + mini‚Äëplayer
- [C2] Paywall UI (preview, unlock, subscribe)
- [C3] Tips ($1‚Äì$10) flow

### EPIC D ‚Äî Subscriptions & Payouts
- [D1] Stripe products/prices + checkout
- [D2] Receipts (fan) + CSV (artist)
- [D3] UCPS job + payout batch + ledger page

### EPIC E ‚Äî Fraud & Security
- [E1] Signed play tokens + heartbeat
- [E2] Raw‚Üívalidated pipeline + rules
- [E3] Ops dashboard for flags

(Each ticket in `docs/product/backlog.csv` with Acceptance Criteria.)

---

## 14) Acceptance Criteria (samples)
**[C2] Paywall UI**
- Given a non‚Äësubscriber, when they open a supporters‚Äëonly track, they see a 30‚Äësec preview and a CTA with 1‚Äëclick Apple/Google Pay.
- After successful purchase, playback resumes seamlessly from 30s ‚Üí full.

**[D3] UCPS job**
- For a user with $9 net allocatable and two artists with 60/40 qualified listen‚Äëtime, payouts compute $5.40/$3.60 ¬± $0.01 rounding.
- Suspicious plays do not affect the split.

---

## 15) Observability
- **PostHog (self‚Äëhost)**: funnels (paywall ‚Üí purchase), feature flags
- **Sentry**: client + server error tracking
- **Dashboards:**
  - Realtime listeners
  - Tips per day
  - Sub churn/expansion
  - Fraud flags per artist

---

## 16) Legal & Policy Docs (templates)
- `/docs/policy/terms.md` ‚Äî ToS including fraud recoupment
- `/docs/policy/privacy.md` ‚Äî GDPR/CCPA disclosures
- `/docs/policy/dmca.md` ‚Äî takedown + counter‚Äënotice
- `/docs/policy/cookies.md` ‚Äî minimal cookies, analytics opt‚Äëout

---

## 17) GTM ‚Äî Cohort Launch Plan (Week 6‚Äì10)
- 10 artists, themed drop; each with: 1 public single, 1 supporter piece (alt mix/stems), 1 unlockable release
- Publish **Public Payout Ledger #1** at end of first month (blog + socials)
- Referral codes (artist ‚Üí fans) with first‚Äëmonth discount

---

## 18) .env.example
```
# Firebase web config (public client keys)
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyB-hOD2vW_KsCi9CKQngeUCPHYVMbDdZiE
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=humane-io.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=humane-io
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=humane-io.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=722090400821
NEXT_PUBLIC_FIREBASE_APP_ID=1:722090400821:web:6a3d51281ce9443703e57c
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=G-HCGW90EDC5

# Stripe / Observability (fill these in)
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
STRIPE_PRICE_FAN=
STRIPE_PRICE_SUPPORTER=
POSTHOG_KEY=
SENTRY_DSN=
```

---

## 19) Agent Superprompt (paste into your AI dev agent)
```
Role: Lead Engineer for HUMANE (ethical DSP). You will scaffold and implement a production‚Äëready MVP using Next.js 14 (app router), Firebase (Auth, Firestore, Storage, Functions), Cloud Run for ffmpeg HLS, Stripe Connect for payments, and PostHog/Sentry for observability. Code in TypeScript with pnpm workspaces and Turborepo. Target: web PWA first.

Non‚Äënegotiables:
- Implement UCPS payouts: per‚Äëuser net allocatable revenue splits by qualified listen time; exclude suspicious plays.
- Access modes per track/release: public_stream, subscribers_only, supporters_only, windowed, buy_to_stream.
- Tips ($1‚Äì$10) and one‚Äëtime unlocks via Stripe; Stripe Connect Express for artist payouts.
- Play ingestion pipeline: signed tokens, heartbeat validation, raw‚Üívalidated materialization; anti‚Äëfraud rules (min 20s or 50% play, dedupe window, device/IP heuristics).
- Fan receipts and artist earnings CSV must reconcile exactly with payout math.

Deliverables (in order):
1) Monorepo tree as specified; pnpm + turbo config; shared `packages/ui` with design tokens.
2) Next.js app with auth, dashboard shell, player shell (sticky mini‚Äëplayer), and paywall components.
3) Firebase init: Firestore, Functions TS, Storage; emulator config; firestore.rules and storage.rules from docs.
4) Cloud Functions stubs from section 6; implement `reportPlayBatch`, `materializeRaw`, `closeMonth`, webhook mapper.
5) Cloud Run Dockerfile for transcoder (ffmpeg) and script to watch `masters/` ‚Üí write HLS.
6) Stripe products/prices seeds, webhook handler, checkout and customer portal pages.
7) Fan Receipt page and CSV export for artists.
8) GitHub Actions CI per section 11; Vercel config for `apps/web`.
9) Playwright E2E: signup‚Üíupload‚Üípaywall‚Üípurchase‚Üíplay‚Üíreceipt.

Quality bars:
- Type‚Äësafe Firestore with zod schemas.
- Error boundaries and loading states for all routes.
- Lighthouse PWA score ‚â• 90 on staging.
- Unit tests for UCPS math and fraud rules.

Conventions:
- Commit convention: Conventional Commits.
- PR template includes checklist for security, accessibility, analytics, and tests.
- Feature flags via PostHog for paywall experiments.

When uncertain: prefer simplicity that ships in under a week. Document tradeoffs in `docs/decisions/ADR-*.md`.
```

---

## 20) Team Roles & Rituals
- **Product/Founder (You):** Vision, artist cohort, policy decisions
- **Systems Architect (Dad):** Pipelines, reliability, cost modeling, security reviews
- **Full‚ÄëStack Lead:** Owns web app & data model end‚Äëto‚Äëend
- **Dev Friends (3):** Feature squads per epic, rotate on-call
- **UX Designer:** Figma ‚Üí shadcn components, accessibility audits
- **Content Developer:** Docs, blog, ledger posts, support articles

**Rituals:**
- Daily 15‚Äëmin standup (async OK). Weekly demo. Biweekly retro. Monthly public ‚ÄúState of HUMANE.‚Äù

---

## 21) Definition of Done (MVP)
- 10 artists onboarded, 50‚Äì100 fans
- ‚â•70% content with non‚Äëpublic access
- First ledger post published, payouts issued ‚â§72h after month end
- Fraud rate <2% of total plays, overturn <25%

---

## 22) What to build first (2‚Äëweek Sprint 1)
- Auth + roles; dashboard shells; upload‚ÜíHLS; access toggles; checkout for Fan+Supporter; tips; basic player; raw‚Üívalidated play pipeline; minimal UCPS job; fan receipt page.

**Milestone demo:** Upload a track, set to Supporters‚ÄëOnly, subscribe as fan, play 2 artists, run UCPS job, show fan receipt and artist CSV with matching sums.



---

# ü§ù HUMANE Team & Agent Playbook

This playbook aligns humans + AI agents (GPT‚Äë5, Gemini, others) for building HUMANE together. Attach in repo as `docs/playbook.md`.

## 1) Roles & Rituals
- **Founder (Bojan):** Vision, partnerships, artist cohort.
- **Systems Architect (Dad):** Reliability, cost modeling, infra decisions.
- **Full‚ÄëStack Lead:** End‚Äëto‚Äëend Next.js + Firebase implementation.
- **Dev Friends (3):** Feature squads per epic; rotate QA and ops.
- **UX Designer:** Wireframes ‚Üí shadcn components ‚Üí accessibility audits.
- **Content Developer:** Docs, ledger posts, onboarding materials.
- **AI Agents (GPT‚Äë5, Gemini):** Code generation, documentation, teaching, scaffolding.

**Rituals:**
- Daily async standup in Slack/Notion.
- Weekly demo (Friday). Record and archive.
- Biweekly retro (team + AI notes on what worked).
- Monthly public "State of HUMANE" ledger post.

---

## 2) File Conventions
- **Source code:** TypeScript, pnpm workspaces.
- **Docs:** Markdown in `/docs/`. PRD in `/docs/product/`, ops in `/docs/ops/`.
- **Decisions:** Architecture Decisions Records ‚Üí `/docs/decisions/ADR-*.md`.
- **Env:** `.env.local` (dev), `.env.staging`, `.env.production`. Never commit secrets.
- **Branches:** `main` ‚Üí stable, `dev/*` ‚Üí feature branches. PR ‚Üí main via review.
- **Commits:** Conventional Commits (`feat:`, `fix:`, `docs:`).

---

## 3) Communication with Agents
- **Use precise prompts**: specify deliverable type (code, doc, config). Example:
  - *‚ÄúImplement Cloud Function for UCPS job. Deliver code + Jest test + docs snippet.‚Äù*
- **Context reminders**: always mention `Project: HUMANE`, Firebase project `humane-io`, local dev macOS.
- **Agents must explain**: after code, output a plain‚Äëlanguage explainer so humans learn.
- **Sync docs**: Agents update `/docs/` alongside code (fraud playbook, API contracts, etc.).

---

## 4) Multi‚ÄëAgent Workflow
- **GPT‚Äë5 (code focus):** Generate scaffolding, functions, tests, infra configs.
- **Gemini (design + product):** Suggest UX flows, discovery features, growth strategy.
- **Cross‚Äëcheck:** Always have at least 2 agents review high‚Äërisk code (fraud rules, payouts).

---

## 5) Sprint Planning
- Break epics into tickets in `/docs/product/backlog.csv`.
- Tag tickets with `[HUMANE-AI]` if agent can handle majority.
- Humans review + merge PRs. Agents never push directly.

---

## 6) Quality Bar
- **Tests:** All UCPS math, fraud detection, Stripe webhooks covered.
- **Performance:** PWA Lighthouse ‚â•90, API p95 <300ms.
- **Security:** Firebase rules locked, secrets in env, no public writes.
- **Docs:** Updated with every PR. Ledger transparent monthly.

---

## 7) Feedback Loop
- **Humans ‚Üí Agents:** Clarify priorities, provide data samples.
- **Agents ‚Üí Humans:** Flag assumptions, ask when policy decision needed.
- **Retro:** Include AI feedback ‚Äî what prompts worked, what didn‚Äôt.

---

## 8) Culture & Vision
- **Transparency first**: Fans see receipts, artists see splits.
- **Ship lean, iterate fast**: MVP > perfection.
- **Ethics encoded**: discovery transparency, fair payouts, privacy by design.
- **Learning culture**: Agents teach, humans learn, both evolve.

---

**This playbook keeps HUMANE‚Äôs human + AI team in sync, ensuring history‚Äëmaking execution.**

